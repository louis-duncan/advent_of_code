from math import inf
from typing import List

test_data = """..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

...............
...............
...............
...............
...............
.....#..#......
.....#.........
.....##..#.....
.......#.......
.......###.....
...............
...............
...............
...............
..............."""

real_data = """######.#..##..######.....#...#.#...#.######.#.#...#..#..#..###.#####.#.####...#.#.#...#.#.#...#####..###.....#.#.....#.#.#..###..#.#.#####..#.....####.##.##..#..##.#.##.##..##.#####.####.#.#....#...#...#...#.#########..#..#####..#.#.###....#.##.###...##.#..#....##.###...#..##.#..#...#.#.#####.####...#.##..##..#.#######...#..##.##.....#..#..#.###...###.######..##.#..##.######....#.##.##...###.##..#.#.#.#########....####.####.#.#...#.#.#..#.#.##.#...#.#..#######..###..##.#..####.###...#.#.#.##.#####.##.###.#.

.##.##...#####.#######.##.##.#####..#.#.#.##.....##...#..#..###.#....###...##.....###......#..##...#
#..#...#.##..#.#..#....#...#...#....####..#.....#.#...##.#..##.##.##...#.#..#..####...#....##.##.##.
...#.#..#..###...##..#.##########...##...#.#.#.#.#####..###..###..##.#..#####..###......##.#.##...##
#..###.##.##...#.#..#.....#.##.#..#...#..####.#.#.##.###....#.#..#..##.#....#.#.#.###...###.#.####.#
...###.....###...##...#..######.###...##.#.##.###.#.#....###.##.###.###.###....######..##.#.#...#..#
###...#.##.#.###..#..#.####.#...#..#.#.#..#.#..#....###..##..####.##.##....#..##.#.##..#.#..#.#.##..
.###.##.#.....#.#.##.##.####.#..#.#..###.##...###..##..##.#.#...#..#.#####...#.####.#....######.#..#
..##.........##.##......##..#.#.#....#..####..#.#..###.##..#.##..####.#.#.##.#.#.##.....##....#.####
#..###..#...###.##.#.#....#.#....###....###...##.#..####.#####.#.##.#...#.#.#.##..#....#..#.#...##.#
###.#..#...#.##.#.#.#..#.####.###...##.####.#.#.........#.##..####.###..#.#...###..#.##..##...####..
#....###.##.##...###...##.###...#..##....#.##.#.##.#.##..#..##..#..#..#...#.##..##.###.#..##.#..###.
.#.#......##..#..#....#.##.#..##.##....#....#..###..##.##..###..#..#.#.##.#.##..#...#.#....#.#...#.#
#.#..#....#.##.##..#.###..##..####.##...##.#.#.###.#.#..#...#.##..#..#.###.....#.##.#####..#......#.
##.##...#.....##.....###.#..##...#.#...#.##..#........#######...#.###.#.#.##..##.#...###..#...#...#.
....###...###.#.#.#.###..#..####..######....###....####..##..#..#.#.###.#.#.#####...#..#.#.####...##
....#######.#....##...#####...###...#...#...#.#...#.###.#.####.#...#.#.#.###....#..#....#.#.#..##..#
#.####.###.#..#.#.#..#####.......##....####.##.####...#..###..#......#..#.#...#....##.....#.........
#..###.#..##.##..###.#.#.#.###.#....#.####.#.###.##.##..#...#.#.#..#..###..#..##......#.####..#.#.##
###.#..##.###....##.#####.###.....#....#####.#..#.#.#.##..#...##...###.##.##...###.##..#..#...#.#..#
#.#...#..#..#.###.#..#..##.#.#.....#.#.#....#.##...##.......####..#...#..#.......###..#.#.#....#..##
.##...##..#..#..####.##.......#...#.###..#..##.#.#.#.##..#..##.###.##.#.#.#..##.##.##..#..###.#..#.#
#...#.###.#......#...#.......##..##...##...#.#....##.#.##.##....##.######..##.##.####.#####....#.#..
#.##.####....##....#..#.#..#.####.#.####.###..##..#.....##.###.#...#...#..#..##.##.###...###.###.#.#
....#.##.##.###.#...#....#...###.#.#......#..#.###.#.#.#.#...#.#..###..#.##.#...##.######..#..####..
####...#.#.###.#...#.......##..#.#######...##...##..##......###.#####.#.#.#.###.#..#.#..##.##..###.#
#.#......#.#.####..##.##...#..######..#.#..#...#..#.####.#.##.#####.#..##..##.#.###.#.#.##.#.#.##.#.
..#.#..#.#...###.#..#.#.##.#.#....###.#..###..##..#######.#.##.####.....#.####.#.##.#...#####......#
#######...##.#.#.###..###.#..##..##...####..###.#.##.##.##...#.##.##.##....#.#..#.###...###.#.#.#...
.##.##..####..#.###########....#...#.#..##......##......#.#..###.##....#..#..#.#..###########..##.##
#....##...###..#.#.###.##......###.#.###.######.#..#.###.#.#.##..#....###.###.#.....#..#..#.#####..#
.######..#.###...###.#..##..#.####.###...###.#.#.####.########.#...#.#.##....####.###.#.##.###...#.#
###..##.##.....#...#.##...#.###...#.#.####..#.##..##..#....#..##.#######.##...#####...##.#...##.##..
###.#.#..###..##.#...####.#..###....###..###..###.###..#.##...#.....#...###.##.#.###.#####.#.##.#.#.
###..######.....#..#.....##.##.##.##...#.#..####....###.#.##...####.#....##.......##.#..###......#.#
##..#.###.##.######.#.##.#...#...###......##.###....##...#.#####.#.##.....#.#..#...####...###...##..
...###..###..##.##..####...##....##.#...#.##..###.###.####...##.#.#.##.#....#.#.###.#..#..#..#.#.##.
..#.###.#.#...#.###..##..##....#.#...#.##.####....#.#.#.#..###.#.#....###.##.#.#...#...#...#..##.#..
###...#.##..##.#..###.#.###.#..#.#.##.#.###...###.#...##.#.......#.#.###....####.....###.##.##.#.#..
.#.####..##.#.#..#######..#..###.#########.#...##..#..##.#.....#.#.##.#.....#.#######..###.....##..#
####.##....#..##.....#...#.#....##.#...####..###.###..#......###.###....##.#.#....###.###.#####..#..
.#.#...##.##.#...#.#...##..###.##..####.###..#....#######..#..##...#####..##...#.#.#######.####.#...
.#.###.######...##.##.#.##...####.#.......#.####.##.#.##.##.####.#...#.#..##....#####.##.#.##..#.#..
..#.#..###.....##....#.###....####.#.##.######..###.##..############.#...#...###.##.#..##.#..####..#
.#.....#.###.#.##....#...#.#####.#.#.##..#...###..##....#..#......#####.#.###..#..####...#####......
.##..#..........##.#.######....##.#.#...###.........#.##..##.......#..#.##......###.....##....#....#
#...#..#.#.#.#.#.####.#..#...#....##.#.#.#....##..#####......##.###.##..#..##...#.##...#....#.##.#..
...#..#.##.####.###.####....##...#......###.###.##....#...##.##.#..#.##.#.....#.##.#.##.##.#.###...#
..#..##.##.#.#####...#..###.#..###..#.####...#.#.##.#...#...#.#.#.###.#.#..##.##..#.##..#....#..###.
..#.#.###...##.#...#.#.#####...###.##...#..###.....#...##.#....##...###.##.####..#..##....#####.##.#
..#.#...#.###...##.##....##.####.....##.##....###..#...#.###..##.#.#.#.##..##...##....#.###.####.#.#
#...#####.##.#.#.#.#...#..###..#.##..##....#..#.###...#.####.###.##.#.##.##......####.....#####..###
.#.#.....#.######.#..#.##..###..#.###.###.##..#.##.....#......#..##.#...###.###..#.#..#.###...#.####
####.##.##.###..#.##.##.#.###.#...##...#..#.###.....#..##..###..#.#..#...#.##.#..#.##.#..#..#.#..#.#
#####.##.####.#######.#.##..##..#.#####..#..#.###..###..#..#.##...#..##.#####...###.#..##.#.###.#..#
...##..##.#.#.###..#.##.#.###....#...###.#####.#.#.#.#......#.###..#..##..#........#.#..#.##..#....#
#.#..#####.##.###...#...###..#.###.......#.#..#..#.#...###....####.###........#.###.####..####.#..#.
........#.##....#.##...#..##...##.####.##.#.##..##......###.#..#.#####..##.#.......##....##..##..#.#
..####.##...###..#####...#..####..###.##.#.#.#.#.....##.##...#.#....###..#..#.##....#...#.####...##.
..##..#.##....##.####.#.#..####.....#.###..#...##..##.#......##...###.....##.....#....##...##.##..##
.#.##...#####..##.##.#..#...#####....#.....#.##.#.##..#...###########...###..#.##.###....#.##.#####.
####......####.#####..###...#.####..#.#..###..#...##..##..#.#.#####.###.##.##..#####.##.#.###.##..#.
##.#..#.####.##..#..#.###.....###.#####.#.#####......#...##..#....##.#.##..###.#####..#.##.#..#..###
.##..####..###....#...#..#.###.#.##..#..#.###..###.##.##...#...##.#..#...#.###..#.###.#.##..##.##.##
#.##..##.#....###.###...#.#.###..#.######..##.#....###.#.###.####..#...#.#..#.#.##.###...##...#.#...
#.#.##.#..#.##....###..###...#...#.#..##.#..##.#..#.##..#.#..####.#....###.#..##..#...#.###.###..#.#
##.##..#####..##.##.##.##..#.....###..#..###..#.##.##.##.#..##.#..#..###.####..#.#####.##.#####.#.##
...###.#...#...###......###.#....##..##.##..########..###....###.####.#..###.######.##.......####.##
##.#.#..#.##.##..#...#...#....#....#....##.#..##.#......#.#.#.#...#.#.####.#.##..#..#.##.##.####...#
##.##...#.#.#.##..#.#....##...###.#####..###..#.###.###.#..###......##.###....##.#.##.####....#####.
.#.#.#####.#......#.##.#.###.#...#.##..#.#....###.##...#...#..##.####..####..###...#..##......###...
###.....##...#######..#.####.....#...#.#...#..#.###.##..#.#....#.#####..##.#.#.#####..#.#.####.#.##.
..#..##..#.#..#...#.#.....##.#.#..##..#.#...#.##.....#...###..##..#.#.#..####..#..#.#.###...#.##.#.#
#...##..#.######.##.#.###.#....#..#.#....#...########.....#####.####....#.##.##..#.#.#...#..##..###.
.#####..####.#..#..#.##.#...#..##.#..##...#....##.#.###......#.......#.....###.....##.####...##..###
##.#...#......###.#.....#..#######.##..#.#.#####..#....##..#..##.#...#.##..#...#.#...#.#.##.#.#####.
#.###..#.####..##..#######....#######..##...###..#.#..#....#.####....#...####.#..###.####...##.#.##.
.#..##..#.#.#.#######...#.#.#.#..#.....###.##..###...#.#.##.#..#.##...#..##..#...#.#...###...####...
...#.#.#.....#.######..##..#.###.###.#.#.###..#....##...###......#.##..#####...###...#...##.#...##..
#.#.......#.##......#...######.....#.###..#####..#.###.##..##...###.##..######...##.#..###.##.#..#.#
....#..##.#.....###.###.#....###..####....#.....###..#.....##.##.##.#..#.#.##...#.##..#.#....###...#
####....#.###..########.##......###....#####.#.#..###.#.#.##.######.#...##...#.###.##.#.....####..##
#####.####....#....###...#.#.#.###.#####..##...#...#.##..#######...#......#...#..####.##......#####.
..##.##.#..#.#.##..##.##..#..#....#.....#######...#..#......#.#.##...#.#.#....###...##..##.#...#.##.
.##.##.#....##.###....#.####....####..##....######.....####.####.#..#.....#####.##.#.##.######....#.
..#...#......##...#..#.#...#.#####..###..#.#..####....#...##.....#.#.#.##.##..#.#.###.##..#.####.#..
.#..#.##.#...#....####.##..##..#####..#..#.#####...##.#.#..####.#...##....#..#####.##.##..##.#..#..#
.##..#.###...#.#..###.###.#......######..#.#.####...#...#..##.########.##..#.###......#.##.#...#.#.#
...#.#..##..#....#..#####.#..######.#..#.#.#...##.######..##..####......#.##.##.#..#..#.##.##...#.#.
#..#.###.####.#.....#...#.....#..##.......#...#..###.###.#.....#.##.#..#.###....##..#...##.#....#...
.##...#..##..##.##...##.##..#.#.#..#.#.#####.####....#....#.#..#..#.#..#...#..#....#.#.#.######....#
#..##.##..#...#....#####....#####...#..#.##.##..##.#..#####.#..####.##.#.#####.#..##.#......##.#..##
#...##.#...#..###....####.##.#.#..#.#.#.#.#..#.#..#..##.#.#.#####...##.##.##.##.##.###...##..#...#.#
#.#..###.....#..####.#.###.######...#######.####..#..##..#.....##.###..#.#.##.###.#.#..##.#.###..###
....###..###.###....####....##..##...#..#...##.#...###..#..#.##...#......###.####...#...#..#.....#.#
#.#..##.##.....####.#..##...#.##.#..#.#.....##.####.#.##.##..#.....####.###.##..##...##...##.#..##.#
######..#.###.##..#......#.###.#.#.....##.###...##..##.###....##....##.##.#.#.#...#..#..#..###..#..#
..#...#...######.##.#.##..#.#.#.#.#.#.#####.####.######.####.##.#.#.#.#....#..#....####.#.##..#.#.##
####..#.##.#..###...##...###.###.####...#.##.####.###.###.##..####.##.#....#..###..#..##.##.#.....#.
.##.##.##.....#######.#..##.#...#.#####.#....##..#...#..##...##...#..#.#..#...#.#..#.###.###.##.###.
...##.#.#.##..#..#..#.#.....##..#.##..##.#..###..#...###......#.###..##..#####..##.###.##....#.##.#."""


def print_image(image_grid: List[List[int]]):
    lines = []
    for line in image_grid:
        new_line = ""
        for i in line:
            if i == 0:
                new_line += "."
            elif i == 1:
                new_line += "#"
            else:
                new_line += "?"
        lines.append(new_line)
    print("\n".join(lines))


def pad_image(image: List[List[int]], pad: int = 2):
    for line in image:
        for _ in range(pad):
            line.insert(0, 0)
            line.append(0)
    for _ in range(pad):
        image.insert(0, [0] * len(image[0]))
        image.append([0] * len(image[0]))


def crop_image_to_content(image: List[List[int]]):
    min_x = inf
    max_x = 0
    first_line = 0
    last_line = inf
    in_image = False
    for i, line in enumerate(image):
        if 1 in line:
            if not in_image:
                in_image = True
                first_line = i
            last_line = i
            in_x_range = False
            for x in range(len(line)):
                if line[x]:
                    if not in_x_range:
                        in_x_range = True
                    if x < min_x:
                        min_x = x
                    if x > max_x:
                        max_x = x
    output_grid = []
    for line in image[first_line: last_line + 1]:
        output_grid.append(line[min_x: max_x + 1])
    return output_grid


def crop_by_border(image: List[List[int]], border: int = 2) -> List[List[int]]:
    output = []
    for line in image[border: len(image) - border]:
        output.append(line[border: len(line) - border])
    return output


def main():
    global test_data, real_data
    data = real_data
    look_up_string, map_string = data.split("\n\n")
    look_up: List[int] = [0 if c == "." else 1 for c in look_up_string]
    image_grid: List[List[int]] = [[0 if c == "." else 1 for c in line] for line in map_string.split("\n")]

    #print_image(image_grid)
    #print()
    pad_image(image_grid, 200)

    for s in range(50):
        #print(f"Before step {s+1}")
        # print_image(image_grid)
        # print()
        output_image: List[List[int]] = [[int(not i) for i in image_grid[0]]]
        for y in range(1, len(image_grid)-1):
            output_line = [int(not image_grid[y][0])]
            for x in range(1, len(image_grid[0])-1):
                look_up_value = (image_grid[y - 1][x - 1] << 8) + (image_grid[y - 1][x] << 7) + (image_grid[y - 1][x + 1] << 6)
                look_up_value += (image_grid[y][x - 1] << 5) + (image_grid[y][x] << 4) + (image_grid[y][x + 1] << 3)
                look_up_value += (image_grid[y + 1][x - 1] << 2) + (image_grid[y + 1][x] << 1) + image_grid[y + 1][x + 1]
                output_line.append(look_up[look_up_value])
            output_line.append(int(not image_grid[y][-1]))
            output_image.append(output_line)
        output_image.append([int(not i) for i in image_grid[-1]])
        # print(f"After step {s + 1}, before crop")
        # print_image(output_image)
        # image_grid = crop_image(output_image)
        # print()
        # print(f"After step {s + 1}, after crop")
        # print_image(output_image)
        # print()
        image_grid = output_image
        #print(f"step {s+1}")
        #print_image(image_grid)
    count = 0
    for line in image_grid:
        count += line.count(1)
    print(count)


if __name__ == '__main__':
    main()
